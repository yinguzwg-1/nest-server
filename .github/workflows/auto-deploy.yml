name: ğŸš€ Nest.js Auto Build and Deploy with Docker

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}
  APP_NAME: nest-server
  CONTAINER_NAME: nest-server-app
  PORT: 3001

permissions:
  contents: read
  packages: write

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒï¼ˆç¨³å®šä¸å˜ï¼‰
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    outputs:
      latest_tag: ${{ steps.meta.outputs.tags }}
      short_sha_tag: ${{ steps.extract_tag.outputs.short_sha_tag }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: ğŸ·ï¸ Extract image metadata (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ env.APP_NAME }}
          tags: |
            type=sha,prefix=${{ github.ref_name }}-,format=short
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.branch=${{ github.ref_name }}

      - name: ğŸ“Œ Extract short SHA tag (å¸¦è°ƒè¯•)
        id: extract_tag
        run: |
          echo "ğŸ” è°ƒè¯•ï¼šmetadata è¾“å‡ºçš„æ‰€æœ‰æ ‡ç­¾ï¼š${{ steps.meta.outputs.tags }}"
          SHORT_SHA_TAG=$(echo "${{ steps.meta.outputs.tags }}" | awk -F ',' '{for(i=1;i<=NF;i++) if($i ~ /${{ github.ref_name }}-/) print $i}')
          
          if [ -z "$SHORT_SHA_TAG" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªä» metadata ä¸­æå–åˆ°çŸ­SHAæ ‡ç­¾"
            echo "å½“å‰åˆ†æ”¯åï¼š${{ github.ref_name }}"
            echo "metadata è¾“å‡ºï¼š${{ steps.meta.outputs.tags }}"
            exit 1
          fi
          
          echo "short_sha_tag=$SHORT_SHA_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æˆåŠŸæå–çŸ­SHAæ ‡ç­¾ï¼š$SHORT_SHA_TAG"

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
          platforms: linux/amd64

      - name: ğŸ“‹ ç¡®è®¤é•œåƒæ¨é€ç»“æœ
        run: |
          echo "âœ… é•œåƒæ¨é€å®Œæˆï¼Œæ¨é€çš„æ ‡ç­¾ï¼š"
          echo "${{ steps.meta.outputs.tags }}"
          echo "çŸ­SHAæ ‡ç­¾ï¼ˆä¼ é€’ç»™éƒ¨ç½²é˜¶æ®µï¼‰ï¼š${{ steps.extract_tag.outputs.short_sha_tag }}"

  # ç¬¬äºŒé˜¶æ®µï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆæ ¸å¿ƒä¿®å¤å®¹å™¨æ¸…ç†é€»è¾‘ï¼‰
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # æµ‹è¯•æœåŠ¡å™¨è¿æ¥ï¼ˆåŸºç¡€éªŒè¯ï¼‰
      - name: ğŸ” Test server connectivity
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          command_timeout: "600s"
          script: |
            echo "ğŸ” æœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸï¼"
            echo "ğŸ–¥ï¸ æœåŠ¡å™¨ç³»ç»Ÿï¼š$(uname -a)"
            echo "ğŸ³ Docker ç‰ˆæœ¬ï¼š$(docker --version)"
            echo "âœ… Docker çŠ¶æ€ï¼š$(systemctl is-active docker)"

      # æ ¸å¿ƒéƒ¨ç½²æ­¥éª¤ï¼ˆå·²ä¿®å¤å®¹å™¨æ¸…ç†æŠ¥é”™ï¼‰
      - name: ğŸš€ Deploy to server (Docker å¸¦è°ƒè¯•)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          command_timeout: "600s"
          script: |
            # é”™è¯¯è¿½è¸ªï¼šé‡åˆ°é”™è¯¯ç«‹å³åœæ­¢+æ‰“å°æ‰§è¡Œå‘½ä»¤
            set -euo pipefail
            set -x

            # 1. å®šä¹‰æ ¸å¿ƒå˜é‡ï¼ˆæ˜¾å¼ä¼ é€’ï¼Œé¿å…ä¾èµ–ç¯å¢ƒï¼‰
            IMAGE_FULL_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ env.APP_NAME }}"
            SHORT_SHA_TAG="${{ needs.build-and-push.outputs.short_sha_tag }}"
            LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ env.APP_NAME }}:latest"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.PORT }}"
            DEPLOY_ENV="${{ github.event.inputs.environment || 'production' }}"
            GITHUB_ACTOR="${{ github.actor }}"
            GHCR_REGISTRY="${{ env.REGISTRY }}"

            # 2. è°ƒè¯•å˜é‡ï¼šç¡®è®¤æ‰€æœ‰å‚æ•°ä¼ é€’æ­£å¸¸
            echo -e "\nğŸ” ã€éƒ¨ç½²è°ƒè¯•ã€‘å½“å‰å˜é‡å€¼ï¼š"
            echo "IMAGE_FULL_NAME: $IMAGE_FULL_NAME"
            echo "SHORT_SHA_TAG: $SHORT_SHA_TAG"
            echo "LATEST_TAG: $LATEST_TAG"
            echo "CONTAINER_NAME: $CONTAINER_NAME"
            echo "PORT: $PORT"
            echo "DEPLOY_ENV: $DEPLOY_ENV"

            # 3. å‰ç½®æ£€æŸ¥ï¼šç¡®ä¿DockeræœåŠ¡æ­£å¸¸è¿è¡Œ
            echo -e "\nâœ… ã€éƒ¨ç½²å‰ç½®ã€‘æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€ï¼š"
            if ! systemctl is-active --quiet docker; then
              echo "âš ï¸ DockeræœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
              sudo systemctl start docker
              sleep 3  # ç­‰å¾…æœåŠ¡å¯åŠ¨
              if ! systemctl is-active --quiet docker; then
                echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œéƒ¨ç½²ä¸­æ–­"
                exit 1
              fi
            fi
            echo "âœ… DockeræœåŠ¡è¿è¡Œæ­£å¸¸"

            # 4. GHCRç™»å½•ï¼šå¸¦æƒé™éªŒè¯å’Œé”™è¯¯æç¤º
            echo -e "\nğŸ” ã€æ­¥éª¤1ã€‘ç™»å½•GHCRå®¹å™¨ä»“åº“ï¼š"
            echo "è°ƒè¯•ï¼šGHCR_PATå‰5ä½ï¼ˆè„±æ•ï¼‰ï¼š${{ secrets.GHCR_PAT }}..."
            if ! echo "${{ secrets.GHCR_PAT }}" | docker login "$GHCR_REGISTRY" -u "$GITHUB_ACTOR" --password-stdin; then
              echo -e "\nâŒ GHCRç™»å½•å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š"
              echo "1. PATæ˜¯å¦åŒ…å«ã€Œread:packagesã€ã€Œwrite:packagesã€æƒé™"
              echo "2. ç”¨æˆ·åæ˜¯å¦ä¸ºæ­£ç¡®GitHubè´¦å·ï¼ˆå½“å‰ï¼š$GITHUB_ACTORï¼‰"
              exit 1
            fi
            echo "âœ… GHCRç™»å½•æˆåŠŸ"

            # 5. æ‹‰å–é•œåƒï¼šåŒé‡é‡è¯•ï¼ˆçŸ­SHA â†’ latestï¼‰
            echo -e "\nğŸ“¥ ã€æ­¥éª¤2ã€‘æ‹‰å–Dockeré•œåƒï¼š"
            echo "ç›®æ ‡é•œåƒï¼ˆçŸ­SHAï¼‰ï¼š$SHORT_SHA_TAG"
            if docker pull "$SHORT_SHA_TAG"; then
              echo "âœ… çŸ­SHAæ ‡ç­¾é•œåƒæ‹‰å–æˆåŠŸ"
              TARGET_IMAGE="$SHORT_SHA_TAG"
            else
              echo "âš ï¸ çŸ­SHAæ ‡ç­¾é•œåƒæ‹‰å–å¤±è´¥ï¼Œé‡è¯•latestæ ‡ç­¾ï¼š$LATEST_TAG"
              if docker pull "$LATEST_TAG"; then
                echo "âœ… latestæ ‡ç­¾é•œåƒæ‹‰å–æˆåŠŸ"
                TARGET_IMAGE="$LATEST_TAG"
              else
                echo -e "\nâŒ é•œåƒæ‹‰å–å¤±è´¥ï¼è¯·æ£€æŸ¥é•œåƒåœ°å€å’ŒæœåŠ¡å™¨ç½‘ç»œ"
                exit 1
              fi
            fi

            # ã€æ ¸å¿ƒä¿®å¤ã€‘6. æ¸…ç†æ—§å®¹å™¨ï¼šå…ˆåˆ¤æ–­å­˜åœ¨æ€§ï¼Œé¿å…æŠ¥é”™
            echo -e "\nğŸ›‘ ã€æ­¥éª¤3ã€‘æ¸…ç†æ—§å®¹å™¨ï¼š"
            # æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„å®¹å™¨ï¼‰
            CONTAINER_EXISTS=$(docker ps -aq -f "name=^/${CONTAINER_NAME}$" | wc -l)
            if [ "$CONTAINER_EXISTS" -eq 1 ]; then
              echo "â„¹ï¸ æ‰¾åˆ°æ—§å®¹å™¨ $CONTAINER_NAMEï¼Œå¼€å§‹æ¸…ç†..."
              # è‹¥å®¹å™¨æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
              if docker ps -q -f "name=^/${CONTAINER_NAME}$"; then
                docker stop "$CONTAINER_NAME"
                echo "âœ… æ—§å®¹å™¨å·²åœæ­¢"
              fi
              # åˆ é™¤å·²åœæ­¢çš„å®¹å™¨
              docker rm "$CONTAINER_NAME"
              echo "âœ… æ—§å®¹å™¨å·²åˆ é™¤"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°æ—§å®¹å™¨ $CONTAINER_NAMEï¼Œè·³è¿‡æ¸…ç†æ­¥éª¤"
            fi

            # 7. æ¸…ç†æ‚¬ç©ºé•œåƒï¼šé‡Šæ”¾æœåŠ¡å™¨ç©ºé—´
            echo -e "\nğŸ§¹ ã€æ­¥éª¤4ã€‘æ¸…ç†æ‚¬ç©ºé•œåƒï¼š"
            DANGLING_IMAGES=$(docker images -f "dangling=true" -q)
            if [ -n "$DANGLING_IMAGES" ]; then
              docker rmi -f "$DANGLING_IMAGES"
              echo "âœ… æ¸…ç†æ‚¬ç©ºé•œåƒå®Œæˆï¼ˆæ•°é‡ï¼š$(echo "$DANGLING_IMAGES" | wc -l)ï¼‰"
            else
              echo "â„¹ï¸ æ— æ‚¬ç©ºé•œåƒéœ€è¦æ¸…ç†"
            fi

            # 8. å¯åŠ¨æ–°å®¹å™¨ï¼šæ˜¾å¼å‚æ•°+ç¯å¢ƒå˜é‡
            echo -e "\nğŸš€ ã€æ­¥éª¤5ã€‘å¯åŠ¨æ–°å®¹å™¨ï¼š"
            echo "å®¹å™¨åï¼š$CONTAINER_NAME"
            echo "é•œåƒåœ°å€ï¼š$TARGET_IMAGE"
            echo "ç«¯å£æ˜ å°„ï¼š$PORT:3001"
            docker run -d \
              --name "$CONTAINER_NAME" \
              --restart unless-stopped \
              -p "$PORT:3001" \
              -e NODE_ENV=production \
              -e PORT=3001 \
              -e DB_HOST=223.4.248.176 \
              -e DB_PORT=3306 \
              -e DB_USERNAME=root \
              -e DB_PASSWORD=Qq123456! \
              -e DB_DATABASE=nest_db \
              -e YOUDAO_APP_KEY=20220529001233310 \
              -e YOUDAO_APP_SECRET=yuM_bOR5cbjZVttocWs1 \
              "$TARGET_IMAGE"

            # æ£€æŸ¥å®¹å™¨å¯åŠ¨ç»“æœ
            if docker ps -q -f "name=^/${CONTAINER_NAME}$"; then
              echo "âœ… æ–°å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
              echo "å®¹å™¨IDï¼š$(docker ps -q -f "name=^/${CONTAINER_NAME}$")"
            else
              echo -e "\nâŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼æŸ¥çœ‹æ—¥å¿—ï¼š"
              docker logs "$CONTAINER_NAME" --tail 50
              exit 1
            fi

            # 9. åº”ç”¨å¥åº·æ£€æŸ¥ï¼š10æ¬¡é‡è¯•ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨
            echo -e "\nğŸ” ã€æ­¥éª¤6ã€‘åº”ç”¨å¥åº·æ£€æŸ¥ï¼ˆ10æ¬¡é‡è¯•ï¼‰ï¼š"
            HEALTH_CHECK_PASSED=false
            for i in {1..10}; do
              if curl -m 5 -s "http://localhost:$PORT/health" > /dev/null; then
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "â„¹ï¸ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…5ç§’é‡è¯•..."
                sleep 5
              fi
            done

            # æœ€ç»ˆéƒ¨ç½²ç»“æœæç¤º
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo -e "\nğŸ‰ ã€éƒ¨ç½²å®Œæˆã€‘æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸï¼"
              echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€ï¼šhttp://${{ secrets.HOST }}:$PORT"
              echo "ğŸŒ å¥åº·æ£€æŸ¥åœ°å€ï¼šhttp://${{ secrets.HOST }}:$PORT/health"
              echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬ï¼š${{ github.sha }}"
              echo "ğŸ³ è¿è¡Œå®¹å™¨ï¼š$CONTAINER_NAME"
            else
              echo -e "\nâŒ ã€éƒ¨ç½²å¤±è´¥ã€‘å¥åº·æ£€æŸ¥è¶…æ—¶ï¼"
              echo "ğŸ“‹ å®¹å™¨æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰ï¼š"
              docker logs "$CONTAINER_NAME" --tail 50
              exit 1
            fi