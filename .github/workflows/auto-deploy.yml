name: ğŸš€ Nest.js Auto Build and Deploy with Docker

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}
  APP_NAME: nest-server
  CONTAINER_NAME: nest-server-app
  PORT: 3001

permissions:
  contents: read
  packages: write

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒï¼ˆå¢å¼ºå˜é‡è¾“å‡ºï¼‰
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    outputs:
      latest_tag: ${{ steps.meta.outputs.tags }}
      short_sha_tag: ${{ steps.extract_tag.outputs.short_sha_tag }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: ğŸ·ï¸ Extract image metadata (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ env.APP_NAME }}
          tags: |
            type=sha,prefix=${{ github.ref_name }}-,format=short
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.branch=${{ github.ref_name }}

      # å¢å¼ºï¼šæ˜¾å¼æ‰“å°å…ƒæ•°æ®è¾“å‡ºï¼Œç¡®è®¤æ ‡ç­¾ç”Ÿæˆ
      - name: ğŸ“Œ Extract short SHA tag (å¸¦è°ƒè¯•)
        id: extract_tag
        run: |
          echo "ğŸ” è°ƒè¯•ï¼šmetadata è¾“å‡ºçš„æ‰€æœ‰æ ‡ç­¾ï¼š${{ steps.meta.outputs.tags }}"
          # æå–åˆ†æ”¯å¯¹åº”çš„çŸ­SHAæ ‡ç­¾
          SHORT_SHA_TAG=$(echo "${{ steps.meta.outputs.tags }}" | awk -F ',' '{for(i=1;i<=NF;i++) if($i ~ /${{ github.ref_name }}-/) print $i}')
          
          # å¼ºåˆ¶æ£€æŸ¥æ ‡ç­¾æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™ä¸­æ–­æ„å»º
          if [ -z "$SHORT_SHA_TAG" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªä» metadata ä¸­æå–åˆ°çŸ­SHAæ ‡ç­¾"
            echo "å½“å‰åˆ†æ”¯åï¼š${{ github.ref_name }}"
            echo "metadata è¾“å‡ºï¼š${{ steps.meta.outputs.tags }}"
            exit 1
          fi
          
          echo "short_sha_tag=$SHORT_SHA_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æˆåŠŸæå–çŸ­SHAæ ‡ç­¾ï¼š$SHORT_SHA_TAG"

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
          platforms: linux/amd64
          # å¢å¼ºï¼šæ¨é€åæ‰“å°é•œåƒä¿¡æ¯ï¼Œç¡®è®¤æ¨é€æˆåŠŸ
          outputs: type=docker,dest=/tmp/image.tar
      - name: ğŸ“‹ ç¡®è®¤é•œåƒæ¨é€ç»“æœ
        run: |
          echo "âœ… é•œåƒæ¨é€å®Œæˆï¼Œæ¨é€çš„æ ‡ç­¾ï¼š"
          echo "${{ steps.meta.outputs.tags }}"
          echo "çŸ­SHAæ ‡ç­¾ï¼ˆå°†ä¼ é€’ç»™éƒ¨ç½²é˜¶æ®µï¼‰ï¼š${{ steps.extract_tag.outputs.short_sha_tag }}"

  # ç¬¬äºŒé˜¶æ®µï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆå¸¦å®Œæ•´è°ƒè¯•å’Œé”™è¯¯å¤„ç†ï¼‰
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # æµ‹è¯•è¿æ¥ï¼ˆä¿ç•™åŸºç¡€éªŒè¯ï¼‰
      - name: ğŸ” Test server connectivity
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          command_timeout: "30s"
          script: |
            echo "ğŸ” æœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸï¼"
            echo "ğŸ–¥ï¸ æœåŠ¡å™¨ç³»ç»Ÿï¼š$(uname -a)"
            echo "ğŸ³ Docker ç‰ˆæœ¬ï¼š$(docker --version)"
            echo "âœ… Docker çŠ¶æ€ï¼š$(systemctl is-active docker)"

      # æ ¸å¿ƒéƒ¨ç½²ï¼šå¸¦é”™è¯¯è¿½è¸ªã€å˜é‡è°ƒè¯•ã€è¯¦ç»†æ—¥å¿—
      - name: ğŸš€ Deploy to server (Docker å¸¦è°ƒè¯•)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          command_timeout: "600s"
          script: |
            # å…³é”®ï¼šå¼€å¯ä¸¥æ ¼é”™è¯¯æ£€æŸ¥ï¼Œé‡åˆ°é”™è¯¯ç«‹å³åœæ­¢å¹¶æ˜¾å¼æŠ¥é”™
            set -euo pipefail
            # å¼€å¯å‘½ä»¤æ‰§è¡Œæ—¥å¿—ï¼ˆæ¯æ‰§è¡Œä¸€æ¡å‘½ä»¤éƒ½æ‰“å°ï¼‰
            set -x

            # 1. å®šä¹‰å˜é‡ï¼ˆæ˜¾å¼ä¼ é€’ï¼Œé¿å…ä¾èµ–ç¯å¢ƒå˜é‡ï¼‰
            IMAGE_FULL_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ env.APP_NAME }}"
            SHORT_SHA_TAG="${{ needs.build-and-push.outputs.short_sha_tag }}"
            LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ env.APP_NAME }}:latest"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.PORT }}"
            DEPLOY_ENV="${{ github.event.inputs.environment || 'production' }}"
            GITHUB_ACTOR="${{ github.actor }}"
            GHCR_REGISTRY="${{ env.REGISTRY }}"

            # 2. è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æ ¸å¿ƒå˜é‡ï¼Œç¡®è®¤ä¼ é€’æ­£å¸¸
            echo -e "\nğŸ” ã€éƒ¨ç½²è°ƒè¯•ã€‘å½“å‰å˜é‡å€¼ï¼š"
            echo "IMAGE_FULL_NAME: $IMAGE_FULL_NAME"
            echo "SHORT_SHA_TAG: $SHORT_SHA_TAG"
            echo "LATEST_TAG: $LATEST_TAG"
            echo "CONTAINER_NAME: $CONTAINER_NAME"
            echo "PORT: $PORT"
            echo "DEPLOY_ENV: $DEPLOY_ENV"
            echo "GITHUB_ACTOR: $GITHUB_ACTOR"
            echo "GHCR_REGISTRY: $GHCR_REGISTRY"

            # 3. éƒ¨ç½²å‰ç½®æ£€æŸ¥ï¼šç¡®è®¤DockeræœåŠ¡æ­£å¸¸
            echo -e "\nâœ… ã€éƒ¨ç½²å‰ç½®ã€‘æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€ï¼š"
            if ! systemctl is-active --quiet docker; then
              echo "âš ï¸ DockeræœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
              sudo systemctl start docker
              # ç­‰å¾…3ç§’ç¡®è®¤å¯åŠ¨
              sleep 3
              if ! systemctl is-active --quiet docker; then
                echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œéƒ¨ç½²ä¸­æ–­"
                exit 1
              fi
            fi
            echo "âœ… DockeræœåŠ¡è¿è¡Œæ­£å¸¸"

            # 4. GHCRç™»å½•ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
            echo -e "\nğŸ” ã€æ­¥éª¤1ã€‘ç™»å½•GHCRå®¹å™¨ä»“åº“ï¼š"
            # æ‰“å°PATå‰5ä½ï¼ˆé¿å…æ³„éœ²ï¼‰ï¼Œç¡®è®¤å¯†é’¥ä¼ é€’
            echo "è°ƒè¯•ï¼šGHCR_PATå‰5ä½ï¼š${{ secrets.GHCR_PAT }}..."
            # æ‰§è¡Œç™»å½•ï¼Œå¤±è´¥åˆ™æ‰“å°è¯¦ç»†åŸå› 
            if ! echo "${{ secrets.GHCR_PAT }}" | docker login "$GHCR_REGISTRY" -u "$GITHUB_ACTOR" --password-stdin; then
              echo -e "\nâŒ GHCRç™»å½•å¤±è´¥ï¼è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ï¼š"
              echo "1. GHCR_PATæ˜¯å¦åŒ…å«ã€Œread:packagesã€ã€Œwrite:packagesã€ã€Œdelete:packagesã€æƒé™"
              echo "2. GITHUB_ACTORæ˜¯å¦ä¸ºæ­£ç¡®çš„GitHubç”¨æˆ·åï¼ˆå½“å‰ï¼š$GITHUB_ACTORï¼‰"
              echo "3. ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®GHCRï¼ˆå°è¯• ping ghcr.ioï¼‰"
              exit 1
            fi
            echo "âœ… GHCRç™»å½•æˆåŠŸ"

            # 5. æ‹‰å–é•œåƒï¼ˆåŒé‡é‡è¯•ï¼Œæ˜¾å¼æ—¥å¿—ï¼‰
            echo -e "\nğŸ“¥ ã€æ­¥éª¤2ã€‘æ‹‰å–Dockeré•œåƒï¼š"
            echo "ç›®æ ‡é•œåƒï¼ˆçŸ­SHAï¼‰ï¼š$SHORT_SHA_TAG"
            if docker pull "$SHORT_SHA_TAG"; then
              echo "âœ… çŸ­SHAæ ‡ç­¾é•œåƒæ‹‰å–æˆåŠŸ"
              TARGET_IMAGE="$SHORT_SHA_TAG"
            else
              echo "âš ï¸ çŸ­SHAæ ‡ç­¾é•œåƒæ‹‰å–å¤±è´¥ï¼Œå°è¯•æ‹‰å–latestæ ‡ç­¾ï¼š$LATEST_TAG"
              if docker pull "$LATEST_TAG"; then
                echo "âœ… latestæ ‡ç­¾é•œåƒæ‹‰å–æˆåŠŸ"
                TARGET_IMAGE="$LATEST_TAG"
              else
                echo -e "\nâŒ é•œåƒæ‹‰å–å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š"
                echo "1. é•œåƒæ˜¯å¦å­˜åœ¨äºGHCRï¼ˆåœ°å€ï¼š$LATEST_TAGï¼‰"
                echo "2. æœåŠ¡å™¨ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®GHCR"
                echo "3. ç™»å½•å‡­è¯æ˜¯å¦æœ‰æƒé™æ‹‰å–é•œåƒ"
                exit 1
              fi
            fi

            # 6. æ¸…ç†æ—§å®¹å™¨ï¼ˆå®‰å…¨åœæ­¢+åˆ é™¤ï¼‰
            echo -e "\nğŸ›‘ ã€æ­¥éª¤3ã€‘æ¸…ç†æ—§å®¹å™¨ï¼š"
            if docker ps -q -f "name=^/${CONTAINER_NAME}$"; then
              echo "åœæ­¢æ—§å®¹å™¨ï¼š$CONTAINER_NAME"
              docker stop "$CONTAINER_NAME"
              echo "åˆ é™¤æ—§å®¹å™¨ï¼š$CONTAINER_NAME"
              docker rm "$CONTAINER_NAME"
              echo "âœ… æ—§å®¹å™¨æ¸…ç†å®Œæˆ"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è¿è¡Œä¸­çš„æ—§å®¹å™¨ï¼Œè·³è¿‡æ¸…ç†"
            fi

            # 7. æ¸…ç†æ‚¬ç©ºé•œåƒï¼ˆé‡Šæ”¾ç©ºé—´ï¼‰
            echo -e "\nğŸ§¹ ã€æ­¥éª¤4ã€‘æ¸…ç†æ‚¬ç©ºé•œåƒï¼š"
            DANGLING_IMAGES=$(docker images -f "dangling=true" -q)
            if [ -n "$DANGLING_IMAGES" ]; then
              docker rmi -f "$DANGLING_IMAGES"
              echo "âœ… æ¸…ç†æ‚¬ç©ºé•œåƒå®Œæˆï¼ˆæ•°é‡ï¼š$(echo "$DANGLING_IMAGES" | wc -l)ï¼‰"
            else
              echo "â„¹ï¸ æ— æ‚¬ç©ºé•œåƒéœ€è¦æ¸…ç†"
            fi

            # 8. å¯åŠ¨æ–°å®¹å™¨ï¼ˆæ˜¾å¼å‚æ•°ï¼Œç¯å¢ƒå˜é‡ï¼‰
            echo -e "\nğŸš€ ã€æ­¥éª¤5ã€‘å¯åŠ¨æ–°å®¹å™¨ï¼š"
            echo "å®¹å™¨åï¼š$CONTAINER_NAME"
            echo "é•œåƒåœ°å€ï¼š$TARGET_IMAGE"
            echo "ç«¯å£æ˜ å°„ï¼š$PORT:3001"
            # æ‰§è¡Œå®¹å™¨å¯åŠ¨å‘½ä»¤ï¼ˆæ˜¾å¼æ‰“å°å®Œæ•´å‘½ä»¤ï¼‰
            docker run -d \
              --name "$CONTAINER_NAME" \
              --restart unless-stopped \
              -p "$PORT:3001" \
              -e NODE_ENV=production \
              -e PORT=3001 \
              -e DB_HOST=223.4.248.176 \
              -e DB_PORT=3306 \
              -e DB_USERNAME=deploy_user \
              -e DB_PASSWORD=qq123456 \
              -e DB_DATABASE=nest_db \
              -e YOUDAO_APP_KEY=20220529001233310 \
              -e YOUDAO_APP_SECRET=yuM_bOR5cbjZVttocWs1 \
              "$TARGET_IMAGE"
            # æ£€æŸ¥å¯åŠ¨ç»“æœ
            if docker ps -q -f "name=^/${CONTAINER_NAME}$"; then
              echo "âœ… æ–°å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
              echo "å®¹å™¨IDï¼š$(docker ps -q -f "name=^/${CONTAINER_NAME}$")"
            else
              echo -e "\nâŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼æŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼š"
              docker logs "$CONTAINER_NAME" --tail 50
              exit 1
            fi

            # 9. å¥åº·æ£€æŸ¥ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
            echo -e "\nğŸ” ã€æ­¥éª¤6ã€‘åº”ç”¨å¥åº·æ£€æŸ¥ï¼ˆ10æ¬¡é‡è¯•ï¼‰ï¼š"
            HEALTH_CHECK_PASSED=false
            for i in {1..10}; do
              if curl -f -m 5 -s "http://localhost:$PORT/health" > /dev/null; then
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "â„¹ï¸ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…5ç§’é‡è¯•..."
                sleep 5
              fi
            done
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo -e "\nğŸ‰ ã€éƒ¨ç½²å®Œæˆã€‘æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸï¼"
              echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€ï¼šhttp://${{ secrets.HOST }}:$PORT"
              echo "ğŸŒ å¥åº·æ£€æŸ¥åœ°å€ï¼šhttp://${{ secrets.HOST }}:$PORT/health"
              echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬ï¼š${{ github.sha }}"
              echo "ğŸ³ è¿è¡Œå®¹å™¨ï¼š$CONTAINER_NAME"
            else
              echo -e "\nâŒ ã€éƒ¨ç½²å¤±è´¥ã€‘å¥åº·æ£€æŸ¥è¶…æ—¶ï¼"
              echo "ğŸ“‹ å®¹å™¨æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰ï¼š"
              docker logs "$CONTAINER_NAME" --tail 50
              exit 1
            fi